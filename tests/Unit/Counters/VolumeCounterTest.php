<?php
/**
 * User: alec
 * Date: 19.11.18
 * Time: 20:06
 */

namespace Tests\Unit\Counters;

use AlecRabbit\Circular;
use AlecRabbit\Counters\VolumeCounter;
use AlecRabbit\Rewindable;
use AlecRabbit\Structures\Trade;
use PHPUnit\Framework\TestCase;
use Tests\Unit\DataProviders\CommonTrades;

class VolumeCounterTest extends TestCase
{
    /** @var Rewindable */
    private static $data;
    /** @var string */
    private static $pair;

    /** @var VolumeCounter */
    private $counter;

    public static function setUpBeforeClass()
    {
        static::$pair = 'btc_usd';
        static::$data = new Rewindable(
            [CommonTrades::class, 'generator'],
            new Circular([T_ASK, T_BID]),
            new Circular([static::$pair]),
            new Circular(
                [10000,]
            ),
            new Circular([0.001,])
        );
    }

    /** @test */
    public function instance(): void
    {
        $this->counter = new VolumeCounter();
        $this->assertInstanceOf(VolumeCounter::class, $this->counter);
        $this->assertEquals(DEFAULT_NAME, $this->counter->getName());
        $expected = [
            STR_VOLUMES => [],
            STR_AVERAGES => [],
            STR_EVENTS => [],
        ];

        $this->assertEquals($expected, $this->counter->getVolumeArray());
        $this->assertEquals([], $this->counter->getEventsArray());
        $expected = [
            STR_VOLUMES => [],
            STR_EVENTS => [],
        ];
        $this->assertEquals($expected, $this->counter->getRawData());
    }

    /** @test */
    public function instanceWithSimpleAdd(): void
    {
        $this->counter = new VolumeCounter();
        $this->counter->enableRelativeMode();
        $this->counter->addTrade(
            new Trade(T_SELL, 'btc_usd', 10000, 0.001, 1514764800)
        );
        $this->counter->addTrade(
            new Trade(T_SELL, 'btc_usd', 10000, 0.011, 1514764800)
        );
        $this->counter->addTrade(
            new Trade(T_BUY, 'btc_usd', 10000, 0.04, 1514764800)
        );
        $expected = [
            STR_VOLUMES => [
                STR_TOTAL =>
                    [
                        P_01MIN => [1514764800 => 0.052,],
                        P_03MIN => [1514764800 => 0.052,],
                        P_05MIN => [1514764800 => 0.052,],
                        P_15MIN => [1514764800 => 0.052,],
                        P_30MIN => [1514764800 => 0.052,],
                        P_45MIN => [1514764800 => 0.052,],
                        P_01HOUR => [1514764800 => 0.052,],
                        P_02HOUR => [1514764800 => 0.052,],
                        P_03HOUR => [1514764800 => 0.052,],
                        P_04HOUR => [1514764800 => 0.052,],
                        P_01DAY => [1514764800 => 0.052,],
                    ],
                STR_SELL =>
                    [
                        P_01MIN => [1514764800 => 0.012,],
                        P_03MIN => [1514764800 => 0.012,],
                        P_05MIN => [1514764800 => 0.012,],
                        P_15MIN => [1514764800 => 0.012,],
                        P_30MIN => [1514764800 => 0.012,],
                        P_45MIN => [1514764800 => 0.012,],
                        P_01HOUR => [1514764800 => 0.012,],
                        P_02HOUR => [1514764800 => 0.012,],
                        P_03HOUR => [1514764800 => 0.012,],
                        P_04HOUR => [1514764800 => 0.012,],
                        P_01DAY => [1514764800 => 0.012,],
                    ],
                STR_BUY =>
                    [
                        P_01MIN => [1514764800 => 0.04,],
                        P_03MIN => [1514764800 => 0.04,],
                        P_05MIN => [1514764800 => 0.04,],
                        P_15MIN => [1514764800 => 0.04,],
                        P_30MIN => [1514764800 => 0.04,],
                        P_45MIN => [1514764800 => 0.04,],
                        P_01HOUR => [1514764800 => 0.04,],
                        P_02HOUR => [1514764800 => 0.04,],
                        P_03HOUR => [1514764800 => 0.04,],
                        P_04HOUR => [1514764800 => 0.04,],
                        P_01DAY => [1514764800 => 0.04,],
                    ],
                STR_VP_TOTAL =>
                    [
                        P_01MIN => [1514764800 => 520.0,],
                        P_03MIN => [1514764800 => 520.0,],
                        P_05MIN => [1514764800 => 520.0,],
                        P_15MIN => [1514764800 => 520.0,],
                        P_30MIN => [1514764800 => 520.0,],
                        P_45MIN => [1514764800 => 520.0,],
                        P_01HOUR => [1514764800 => 520.0,],
                        P_02HOUR => [1514764800 => 520.0,],
                        P_03HOUR => [1514764800 => 520.0,],
                        P_04HOUR => [1514764800 => 520.0,],
                        P_01DAY => [1514764800 => 520.0,],
                    ],
                STR_VP_SELL =>
                    [
                        P_01MIN => [1514764800 => 120.0,],
                        P_03MIN => [1514764800 => 120.0,],
                        P_05MIN => [1514764800 => 120.0,],
                        P_15MIN => [1514764800 => 120.0,],
                        P_30MIN => [1514764800 => 120.0,],
                        P_45MIN => [1514764800 => 120.0,],
                        P_01HOUR => [1514764800 => 120.0,],
                        P_02HOUR => [1514764800 => 120.0,],
                        P_03HOUR => [1514764800 => 120.0,],
                        P_04HOUR => [1514764800 => 120.0,],
                        P_01DAY => [1514764800 => 120.0,],
                    ],
                STR_VP_BUY =>
                    [
                        P_01MIN => [1514764800 => 400.0,],
                        P_03MIN => [1514764800 => 400.0,],
                        P_05MIN => [1514764800 => 400.0,],
                        P_15MIN => [1514764800 => 400.0,],
                        P_30MIN => [1514764800 => 400.0,],
                        P_45MIN => [1514764800 => 400.0,],
                        P_01HOUR => [1514764800 => 400.0,],
                        P_02HOUR => [1514764800 => 400.0,],
                        P_03HOUR => [1514764800 => 400.0,],
                        P_04HOUR => [1514764800 => 400.0,],
                        P_01DAY => [1514764800 => 400.0,],
                    ],
                STR_P_SUM_TOTAL =>
                    [
                        P_01MIN => [1514764800 => 30000,],
                        P_03MIN => [1514764800 => 30000,],
                        P_05MIN => [1514764800 => 30000,],
                        P_15MIN => [1514764800 => 30000,],
                        P_30MIN => [1514764800 => 30000,],
                        P_45MIN => [1514764800 => 30000,],
                        P_01HOUR => [1514764800 => 30000,],
                        P_02HOUR => [1514764800 => 30000,],
                        P_03HOUR => [1514764800 => 30000,],
                        P_04HOUR => [1514764800 => 30000,],
                        P_01DAY => [1514764800 => 30000,],
                    ],
                STR_P_SUM_SELL =>
                    [
                        P_01MIN => [1514764800 => 20000,],
                        P_03MIN => [1514764800 => 20000,],
                        P_05MIN => [1514764800 => 20000,],
                        P_15MIN => [1514764800 => 20000,],
                        P_30MIN => [1514764800 => 20000,],
                        P_45MIN => [1514764800 => 20000,],
                        P_01HOUR => [1514764800 => 20000,],
                        P_02HOUR => [1514764800 => 20000,],
                        P_03HOUR => [1514764800 => 20000,],
                        P_04HOUR => [1514764800 => 20000,],
                        P_01DAY => [1514764800 => 20000,],
                    ],
                STR_P_SUM_BUY =>
                    [
                        P_01MIN => [1514764800 => 10000,],
                        P_03MIN => [1514764800 => 10000,],
                        P_05MIN => [1514764800 => 10000,],
                        P_15MIN => [1514764800 => 10000,],
                        P_30MIN => [1514764800 => 10000,],
                        P_45MIN => [1514764800 => 10000,],
                        P_01HOUR => [1514764800 => 10000,],
                        P_02HOUR => [1514764800 => 10000,],
                        P_03HOUR => [1514764800 => 10000,],
                        P_04HOUR => [1514764800 => 10000,],
                        P_01DAY => [1514764800 => 10000,],
                    ],
            ],
            STR_EVENTS => [
                STR_TOTAL =>
                    [
                        P_01MIN => [1514764800 => 3,],
                        P_03MIN => [1514764800 => 3,],
                        P_05MIN => [1514764800 => 3,],
                        P_15MIN => [1514764800 => 3,],
                        P_30MIN => [1514764800 => 3,],
                        P_45MIN => [1514764800 => 3,],
                        P_01HOUR => [1514764800 => 3,],
                        P_02HOUR => [1514764800 => 3,],
                        P_03HOUR => [1514764800 => 3,],
                        P_04HOUR => [1514764800 => 3,],
                        P_01DAY => [1514764800 => 3,],
                    ],
                STR_SELL =>
                    [
                        P_01MIN => [1514764800 => 2,],
                        P_03MIN => [1514764800 => 2,],
                        P_05MIN => [1514764800 => 2,],
                        P_15MIN => [1514764800 => 2,],
                        P_30MIN => [1514764800 => 2,],
                        P_45MIN => [1514764800 => 2,],
                        P_01HOUR => [1514764800 => 2,],
                        P_02HOUR => [1514764800 => 2,],
                        P_03HOUR => [1514764800 => 2,],
                        P_04HOUR => [1514764800 => 2,],
                        P_01DAY => [1514764800 => 2,],
                    ],
                STR_BUY =>
                    [
                        P_01MIN => [1514764800 => 1,],
                        P_03MIN => [1514764800 => 1,],
                        P_05MIN => [1514764800 => 1,],
                        P_15MIN => [1514764800 => 1,],
                        P_30MIN => [1514764800 => 1,],
                        P_45MIN => [1514764800 => 1,],
                        P_01HOUR => [1514764800 => 1,],
                        P_02HOUR => [1514764800 => 1,],
                        P_03HOUR => [1514764800 => 1,],
                        P_04HOUR => [1514764800 => 1,],
                        P_01DAY => [1514764800 => 1,],
                    ],
            ],
        ];
        $this->assertEquals($expected, $this->counter->getRawData());
        $expected = [
            STR_VOLUMES =>
                [
                    STR_TOTAL => [
                        P_01MIN => 0.052,
                        P_03MIN => 0.052,
                        P_05MIN => 0.052,
                        P_15MIN => 0.052,
                        P_30MIN => 0.052,
                        P_45MIN => 0.052,
                        P_01HOUR => 0.052,
                        P_02HOUR => 0.052,
                        P_03HOUR => 0.052,
                        P_04HOUR => 0.052,
                        P_01DAY => 0.052,
                    ],
                    STR_SELL => [
                        P_01MIN => 0.012,
                        P_03MIN => 0.012,
                        P_05MIN => 0.012,
                        P_15MIN => 0.012,
                        P_30MIN => 0.012,
                        P_45MIN => 0.012,
                        P_01HOUR => 0.012,
                        P_02HOUR => 0.012,
                        P_03HOUR => 0.012,
                        P_04HOUR => 0.012,
                        P_01DAY => 0.012,
                    ],
                    STR_BUY => [
                        P_01MIN => 0.04,
                        P_03MIN => 0.04,
                        P_05MIN => 0.04,
                        P_15MIN => 0.04,
                        P_30MIN => 0.04,
                        P_45MIN => 0.04,
                        P_01HOUR => 0.04,
                        P_02HOUR => 0.04,
                        P_03HOUR => 0.04,
                        P_04HOUR => 0.04,
                        P_01DAY => 0.04,
                    ],
                    STR_VP_TOTAL =>
                        [
                            P_01MIN => 520.0,
                            P_03MIN => 520.0,
                            P_05MIN => 520.0,
                            P_15MIN => 520.0,
                            P_30MIN => 520.0,
                            P_45MIN => 520.0,
                            P_01HOUR => 520.0,
                            P_02HOUR => 520.0,
                            P_03HOUR => 520.0,
                            P_04HOUR => 520.0,
                            P_01DAY => 520.0,
                        ],
                    STR_VP_SELL =>
                        [
                            P_01MIN => 120.0,
                            P_03MIN => 120.0,
                            P_05MIN => 120.0,
                            P_15MIN => 120.0,
                            P_30MIN => 120.0,
                            P_45MIN => 120.0,
                            P_01HOUR => 120.0,
                            P_02HOUR => 120.0,
                            P_03HOUR => 120.0,
                            P_04HOUR => 120.0,
                            P_01DAY => 120.0,
                        ],
                    STR_VP_BUY =>
                        [
                            P_01MIN => 400.0,
                            P_03MIN => 400.0,
                            P_05MIN => 400.0,
                            P_15MIN => 400.0,
                            P_30MIN => 400.0,
                            P_45MIN => 400.0,
                            P_01HOUR => 400.0,
                            P_02HOUR => 400.0,
                            P_03HOUR => 400.0,
                            P_04HOUR => 400.0,
                            P_01DAY => 400.0,
                        ],
                    STR_P_SUM_TOTAL =>
                        [
                            P_01MIN => 30000,
                            P_03MIN => 30000,
                            P_05MIN => 30000,
                            P_15MIN => 30000,
                            P_30MIN => 30000,
                            P_45MIN => 30000,
                            P_01HOUR => 30000,
                            P_02HOUR => 30000,
                            P_03HOUR => 30000,
                            P_04HOUR => 30000,
                            P_01DAY => 30000,
                        ],
                    STR_P_SUM_SELL =>
                        [
                            P_01MIN => 20000,
                            P_03MIN => 20000,
                            P_05MIN => 20000,
                            P_15MIN => 20000,
                            P_30MIN => 20000,
                            P_45MIN => 20000,
                            P_01HOUR => 20000,
                            P_02HOUR => 20000,
                            P_03HOUR => 20000,
                            P_04HOUR => 20000,
                            P_01DAY => 20000,
                        ],
                    STR_P_SUM_BUY =>
                        [
                            P_01MIN => 10000,
                            P_03MIN => 10000,
                            P_05MIN => 10000,
                            P_15MIN => 10000,
                            P_30MIN => 10000,
                            P_45MIN => 10000,
                            P_01HOUR => 10000,
                            P_02HOUR => 10000,
                            P_03HOUR => 10000,
                            P_04HOUR => 10000,
                            P_01DAY => 10000,
                        ],
                ],
            STR_AVERAGES =>
                [
                    STR_VWAP_TOTAL =>
                        [
                            P_01MIN => 10000,
                            P_03MIN => 10000,
                            P_05MIN => 10000,
                            P_15MIN => 10000,
                            P_30MIN => 10000,
                            P_45MIN => 10000,
                            P_01HOUR => 10000,
                            P_02HOUR => 10000,
                            P_03HOUR => 10000,
                            P_04HOUR => 10000,
                            P_01DAY => 10000,
                        ],
                    STR_VWAP_SELL =>
                        [
                            P_01MIN => 10000,
                            P_03MIN => 10000,
                            P_05MIN => 10000,
                            P_15MIN => 10000,
                            P_30MIN => 10000,
                            P_45MIN => 10000,
                            P_01HOUR => 10000,
                            P_02HOUR => 10000,
                            P_03HOUR => 10000,
                            P_04HOUR => 10000,
                            P_01DAY => 10000,
                        ],
                    STR_VWAP_BUY =>
                        [
                            P_01MIN => 10000,
                            P_03MIN => 10000,
                            P_05MIN => 10000,
                            P_15MIN => 10000,
                            P_30MIN => 10000,
                            P_45MIN => 10000,
                            P_01HOUR => 10000,
                            P_02HOUR => 10000,
                            P_03HOUR => 10000,
                            P_04HOUR => 10000,
                            P_01DAY => 10000,
                        ],
                    STR_AVG_PRICE_TOTAL =>
                        [
                            P_01MIN => 10000,
                            P_03MIN => 10000,
                            P_05MIN => 10000,
                            P_15MIN => 10000,
                            P_30MIN => 10000,
                            P_45MIN => 10000,
                            P_01HOUR => 10000,
                            P_02HOUR => 10000,
                            P_03HOUR => 10000,
                            P_04HOUR => 10000,
                            P_01DAY => 10000,
                        ],
                    STR_AVG_PRICE_SELL =>
                        [
                            P_01MIN => 10000,
                            P_03MIN => 10000,
                            P_05MIN => 10000,
                            P_15MIN => 10000,
                            P_30MIN => 10000,
                            P_45MIN => 10000,
                            P_01HOUR => 10000,
                            P_02HOUR => 10000,
                            P_03HOUR => 10000,
                            P_04HOUR => 10000,
                            P_01DAY => 10000,
                        ],
                    STR_AVG_PRICE_BUY =>
                        [
                            P_01MIN => 10000,
                            P_03MIN => 10000,
                            P_05MIN => 10000,
                            P_15MIN => 10000,
                            P_30MIN => 10000,
                            P_45MIN => 10000,
                            P_01HOUR => 10000,
                            P_02HOUR => 10000,
                            P_03HOUR => 10000,
                            P_04HOUR => 10000,
                            P_01DAY => 10000,
                        ],
                ],
            STR_EVENTS =>
                [
                    STR_TOTAL => [
                        P_01MIN => 3,
                        P_03MIN => 3,
                        P_05MIN => 3,
                        P_15MIN => 3,
                        P_30MIN => 3,
                        P_45MIN => 3,
                        P_01HOUR => 3,
                        P_02HOUR => 3,
                        P_03HOUR => 3,
                        P_04HOUR => 3,
                        P_01DAY => 3,
                    ],
                    STR_SELL => [
                        P_01MIN => 2,
                        P_03MIN => 2,
                        P_05MIN => 2,
                        P_15MIN => 2,
                        P_30MIN => 2,
                        P_45MIN => 2,
                        P_01HOUR => 2,
                        P_02HOUR => 2,
                        P_03HOUR => 2,
                        P_04HOUR => 2,
                        P_01DAY => 2,
                    ],
                    STR_BUY => [
                        P_01MIN => 1,
                        P_03MIN => 1,
                        P_05MIN => 1,
                        P_15MIN => 1,
                        P_30MIN => 1,
                        P_45MIN => 1,
                        P_01HOUR => 1,
                        P_02HOUR => 1,
                        P_03HOUR => 1,
                        P_04HOUR => 1,
                        P_01DAY => 1,
                    ],
                ],
        ];
        $this->assertEquals($expected, $this->counter->getVolumeArray());
        $expected = [
            STR_TOTAL => [
                P_01MIN => 3,
                P_03MIN => 3,
                P_05MIN => 3,
                P_15MIN => 3,
                P_30MIN => 3,
                P_45MIN => 3,
                P_01HOUR => 3,
                P_02HOUR => 3,
                P_03HOUR => 3,
                P_04HOUR => 3,
                P_01DAY => 3,
            ],
            STR_SELL => [
                P_01MIN => 2,
                P_03MIN => 2,
                P_05MIN => 2,
                P_15MIN => 2,
                P_30MIN => 2,
                P_45MIN => 2,
                P_01HOUR => 2,
                P_02HOUR => 2,
                P_03HOUR => 2,
                P_04HOUR => 2,
                P_01DAY => 2,
            ],
            STR_BUY => [
                P_01MIN => 1,
                P_03MIN => 1,
                P_05MIN => 1,
                P_15MIN => 1,
                P_30MIN => 1,
                P_45MIN => 1,
                P_01HOUR => 1,
                P_02HOUR => 1,
                P_03HOUR => 1,
                P_04HOUR => 1,
                P_01DAY => 1,
            ],
        ];
        $this->assertEquals($expected, $this->counter->getEventsArray(true));
        $expected = [
            STR_VOLUMES => [],
            STR_EVENTS => [],
        ];
        $this->assertEquals($expected, $this->counter->getRawData());
    }

    /** @test */
    public function instanceComplexFill(): void
    {
        $data = new Rewindable(
            [CommonTrades::class, 'generator'],
            new Circular([T_ASK, T_BID]),
            new Circular([static::$pair]),
            new Circular(
                [10000,]
            ),
            new Circular([0.001,])
        );

        $this->counter = new VolumeCounter();
        $this->counter->enableRelativeMode();
        foreach ($data as $trade) {
            $this->counter->addTrade($trade);
        }
        $expected = [
            STR_VOLUMES => [
                STR_TOTAL =>
                    [
                        60 => 0.004,
                        180 => 0.012,
                        300 => 0.02,
                        900 => 0.06000,
                        1800 => 0.12000,
                        2700 => 0.18000,
                        3600 => 0.24000,
                        7200 => 0.48000,
                        10800 => 0.7200,
                        14400 => 0.9600,
                        86400 => 5.760,
                    ],
                STR_SELL =>
                    [
                        60 => 0.002,
                        180 => 0.006,
                        300 => 0.01,
                        900 => 0.030000,
                        1800 => 0.06000,
                        2700 => 0.09000,
                        3600 => 0.12000,
                        7200 => 0.24000,
                        10800 => 0.36000,
                        14400 => 0.48000,
                        86400 => 2.880,
                    ],
                STR_BUY =>
                    [
                        60 => 0.002,
                        180 => 0.006,
                        300 => 0.01,
                        900 => 0.0300000,
                        1800 => 0.060000,
                        2700 => 0.090000,
                        3600 => 0.120000,
                        7200 => 0.240000,
                        10800 => 0.360000,
                        14400 => 0.480000,
                        86400 => 2.8800,
                    ],
                STR_VP_TOTAL =>
                    [
                        60 => 40.0,
                        180 => 120.0,
                        300 => 200.0,
                        900 => 600.0,
                        1800 => 1200.0,
                        2700 => 1800.0,
                        3600 => 2400.0,
                        7200 => 4800.0,
                        10800 => 7200.0,
                        14400 => 9600.0,
                        86400 => 57600.0,
                    ],
                STR_VP_SELL =>
                    [
                        60 => 20.0,
                        180 => 60.0,
                        300 => 100.0,
                        900 => 300.0,
                        1800 => 600.0,
                        2700 => 900.0,
                        3600 => 1200.0,
                        7200 => 2400.0,
                        10800 => 3600.0,
                        14400 => 4800.0,
                        86400 => 28800.0,
                    ],
                STR_VP_BUY =>
                    [
                        60 => 20.0,
                        180 => 60.0,
                        300 => 100.0,
                        900 => 300.0,
                        1800 => 600.0,
                        2700 => 900.0,
                        3600 => 1200.0,
                        7200 => 2400.0,
                        10800 => 3600.0,
                        14400 => 4800.0,
                        86400 => 28800.0,
                    ],
                STR_P_SUM_TOTAL =>
                    [
                        60 => 40000.0,
                        180 => 120000.0,
                        300 => 200000.0,
                        900 => 600000.0,
                        1800 => 1200000.0,
                        2700 => 1800000.0,
                        3600 => 2400000.0,
                        7200 => 4800000.0,
                        10800 => 7200000.0,
                        14400 => 9600000.0,
                        86400 => 57600000.0,
                    ],
                STR_P_SUM_SELL =>
                    [
                        60 => 20000.0,
                        180 => 60000.0,
                        300 => 100000.0,
                        900 => 300000.0,
                        1800 => 600000.0,
                        2700 => 900000.0,
                        3600 => 1200000.0,
                        7200 => 2400000.0,
                        10800 => 3600000.0,
                        14400 => 4800000.0,
                        86400 => 28800000.0,
                    ],
                STR_P_SUM_BUY =>
                    [
                        60 => 20000.0,
                        180 => 60000.0,
                        300 => 100000.0,
                        900 => 300000.0,
                        1800 => 600000.0,
                        2700 => 900000.0,
                        3600 => 1200000.0,
                        7200 => 2400000.0,
                        10800 => 3600000.0,
                        14400 => 4800000.0,
                        86400 => 28800000.0,
                    ],
            ],
            STR_AVERAGES => [
                STR_VWAP_TOTAL =>
                    [
                        60 => 10000.0,
                        180 => 10000.0,
                        300 => 10000.0,
                        900 => 10000.0,
                        1800 => 10000.0,
                        2700 => 10000.0,
                        3600 => 10000.0,
                        7200 => 10000.0,
                        10800 => 10000.0,
                        14400 => 10000.0,
                        86400 => 10000.0,
                    ],
                STR_VWAP_SELL =>
                    [
                        60 => 10000.0,
                        180 => 10000.0,
                        300 => 10000.0,
                        900 => 10000.0,
                        1800 => 10000.0,
                        2700 => 10000.0,
                        3600 => 10000.0,
                        7200 => 10000.0,
                        10800 => 10000.0,
                        14400 => 10000.0,
                        86400 => 10000.0,
                    ],
                STR_VWAP_BUY =>
                    [
                        60 => 10000.0,
                        180 => 10000.0,
                        300 => 10000.0,
                        900 => 10000.0,
                        1800 => 10000.0,
                        2700 => 10000.0,
                        3600 => 10000.0,
                        7200 => 10000.0,
                        10800 => 10000.0,
                        14400 => 10000.0,
                        86400 => 10000.0,
                    ],
                STR_AVG_PRICE_TOTAL =>
                    [
                        60 => 10000.0,
                        180 => 10000.0,
                        300 => 10000.0,
                        900 => 10000.0,
                        1800 => 10000.0,
                        2700 => 10000.0,
                        3600 => 10000.0,
                        7200 => 10000.0,
                        10800 => 10000.0,
                        14400 => 10000.0,
                        86400 => 10000.0,
                    ],
                STR_AVG_PRICE_SELL =>
                    [
                        60 => 10000.0,
                        180 => 10000.0,
                        300 => 10000.0,
                        900 => 10000.0,
                        1800 => 10000.0,
                        2700 => 10000.0,
                        3600 => 10000.0,
                        7200 => 10000.0,
                        10800 => 10000.0,
                        14400 => 10000.0,
                        86400 => 10000.0,
                    ],
                STR_AVG_PRICE_BUY =>
                    [
                        60 => 10000.0,
                        180 => 10000.0,
                        300 => 10000.0,
                        900 => 10000.0,
                        1800 => 10000.0,
                        2700 => 10000.0,
                        3600 => 10000.0,
                        7200 => 10000.0,
                        10800 => 10000.0,
                        14400 => 10000.0,
                        86400 => 10000.0,
                    ],
            ],
            STR_EVENTS => [
                STR_TOTAL => [
                    P_01MIN => 4,
                    P_03MIN => 12,
                    P_05MIN => 20,
                    P_15MIN => 60,
                    P_30MIN => 120,
                    P_45MIN => 180,
                    P_01HOUR => 240,
                    P_02HOUR => 480,
                    P_03HOUR => 720,
                    P_04HOUR => 960,
                    P_01DAY => 5760,
                ],
                STR_SELL => [
                    P_01MIN => 2,
                    P_03MIN => 6,
                    P_05MIN => 10,
                    P_15MIN => 30,
                    P_30MIN => 60,
                    P_45MIN => 90,
                    P_01HOUR => 120,
                    P_02HOUR => 240,
                    P_03HOUR => 360,
                    P_04HOUR => 480,
                    P_01DAY => 2880,
                ],
                STR_BUY => [
                    P_01MIN => 2,
                    P_03MIN => 6,
                    P_05MIN => 10,
                    P_15MIN => 30,
                    P_30MIN => 60,
                    P_45MIN => 90,
                    P_01HOUR => 120,
                    P_02HOUR => 240,
                    P_03HOUR => 360,
                    P_04HOUR => 480,
                    P_01DAY => 2880,
                ],
            ],

        ];
        $this->assertEquals($expected, $this->counter->getVolumeArray());
    }

    /** @test */
    public function instanceComplexFillTwo(): void
    {
        $data = new Rewindable(
            [CommonTrades::class, 'generator'],
            new Circular([T_ASK, T_BID,]),
            new Circular([static::$pair]),
            new Circular(
                [10001, 10002, 10000, 10001]
            ),
            new Circular([0.001, 0.001, 0.002, 0.002])
        );

        $this->counter = new VolumeCounter();
        $this->counter->enableRelativeMode();
        foreach ($data as $trade) {
            $this->counter->addTrade($trade);
        }
        $expected =
            [
                STR_VOLUMES => [
                    STR_TOTAL =>
                        [
                            60 => 0.006,
                            180 => 0.018,
                            300 => 0.03,
                            900 => 0.09,
                            1800 => 0.18,
                            2700 => 0.27,
                            3600 => 0.36,
                            7200 => 0.72,
                            10800 => 1.08,
                            14400 => 1.44,
                            86400 => 8.64,
                        ],
                    STR_SELL =>
                        [
                            60 => 0.003,
                            180 => 0.009,
                            300 => 0.015,
                            900 => 0.045,
                            1800 => 0.09,
                            2700 => 0.135,
                            3600 => 0.18,
                            7200 => 0.36,
                            10800 => 0.54,
                            14400 => 0.72,
                            86400 => 4.32,
                        ],
                    STR_BUY =>
                        [
                            60 => 0.003,
                            180 => 0.00900,
                            300 => 0.015,
                            900 => 0.045,
                            1800 => 0.09,
                            2700 => 0.135,
                            3600 => 0.18,
                            7200 => 0.36,
                            10800 => 0.54,
                            14400 => 0.72,
                            86400 => 4.32,
                        ],
                    STR_VP_TOTAL =>
                        [
                            60 => 60.005,
                            180 => 180.015,
                            300 => 300.025,
                            900 => 900.075,
                            1800 => 1800.15,
                            2700 => 2700.225,
                            3600 => 3600.3,
                            7200 => 7200.6,
                            10800 => 10800.9,
                            14400 => 14401.2,
                            86400 => 86407.2,
                        ],
                    STR_VP_SELL =>
                        [
                            60 => 30.001,
                            180 => 90.003,
                            300 => 150.005,
                            900 => 450.015,
                            1800 => 900.03,
                            2700 => 1350.045,
                            3600 => 1800.06,
                            7200 => 3600.12,
                            10800 => 5400.18,
                            14400 => 7200.24,
                            86400 => 43201.44,
                        ],
                    STR_VP_BUY =>
                        [
                            60 => 30.003999999999998,
                            180 => 90.012,
                            300 => 150.01999999999998,
                            900 => 450.05999999999995,
                            1800 => 900.1199999999999,
                            2700 => 1350.1799999999998,
                            3600 => 1800.2400000000007,
                            7200 => 3600.4800000000023,
                            10800 => 5400.720000000004,
                            14400 => 7200.9600000000055,
                            86400 => 43205.75999999993,
                        ],
                    STR_P_SUM_TOTAL =>
                        [
                            60 => 40004.0,
                            180 => 120012.0,
                            300 => 200020.0,
                            900 => 600060.0,
                            1800 => 1200120.0,
                            2700 => 1800180.0,
                            3600 => 2400240.0,
                            7200 => 4800480.0,
                            10800 => 7200720.0,
                            14400 => 9600960.0,
                            86400 => 57605760.0,
                        ],
                    STR_P_SUM_SELL =>
                        [
                            60 => 20001.0,
                            180 => 60003.0,
                            300 => 100005.0,
                            900 => 300015.0,
                            1800 => 600030.0,
                            2700 => 900045.0,
                            3600 => 1200060.0,
                            7200 => 2400120.0,
                            10800 => 3600180.0,
                            14400 => 4800240.0,
                            86400 => 28801440.0,
                        ],
                    STR_P_SUM_BUY =>
                        [
                            60 => 20003.0,
                            180 => 60009.0,
                            300 => 100015.0,
                            900 => 300045.0,
                            1800 => 600090.0,
                            2700 => 900135.0,
                            3600 => 1200180.0,
                            7200 => 2400360.0,
                            10800 => 3600540.0,
                            14400 => 4800720.0,
                            86400 => 28804320.0,
                        ],
                ],
                STR_AVERAGES => [
                    STR_VWAP_TOTAL =>
                        [
                            60 => 10000.833333333332,
                            180 => 10000.833333333332,
                            300 => 10000.833333333332,
                            900 => 10000.83333333333,
                            1800 => 10000.833333333328,
                            2700 => 10000.833333333328,
                            3600 => 10000.833333333318,
                            7200 => 10000.833333333316,
                            10800 => 10000.833333333316,
                            14400 => 10000.833333333316,
                            86400 => 10000.833333333332,
                        ],
                    STR_VWAP_SELL =>
                        [
                            60 => 10000.333333333332,
                            180 => 10000.33333333333,
                            300 => 10000.333333333334,
                            900 => 10000.333333333332,
                            1800 => 10000.333333333332,
                            2700 => 10000.333333333334,
                            3600 => 10000.333333333325,
                            7200 => 10000.333333333323,
                            10800 => 10000.333333333323,
                            14400 => 10000.333333333321,
                            86400 => 10000.333333333318,
                        ],
                    STR_VWAP_BUY =>
                        [
                            60 => 10001.333333333332,
                            180 => 10001.333333333332,
                            300 => 10001.333333333332,
                            900 => 10001.33333333333,
                            1800 => 10001.33333333333,
                            2700 => 10001.333333333332,
                            3600 => 10001.333333333332,
                            7200 => 10001.333333333332,
                            10800 => 10001.333333333334,
                            14400 => 10001.333333333334,
                            86400 => 10001.33333333331,
                        ],
                    STR_AVG_PRICE_TOTAL =>
                        [
                            60 => 10001.0,
                            180 => 10001.0,
                            300 => 10001.0,
                            900 => 10001.0,
                            1800 => 10001.0,
                            2700 => 10001.0,
                            3600 => 10001.0,
                            7200 => 10001.0,
                            10800 => 10001.0,
                            14400 => 10001.0,
                            86400 => 10001.0,
                        ],
                    STR_AVG_PRICE_SELL =>
                        [
                            60 => 10000.5,
                            180 => 10000.5,
                            300 => 10000.5,
                            900 => 10000.5,
                            1800 => 10000.5,
                            2700 => 10000.5,
                            3600 => 10000.5,
                            7200 => 10000.5,
                            10800 => 10000.5,
                            14400 => 10000.5,
                            86400 => 10000.5,
                        ],
                    STR_AVG_PRICE_BUY =>
                        [
                            60 => 10001.5,
                            180 => 10001.5,
                            300 => 10001.5,
                            900 => 10001.5,
                            1800 => 10001.5,
                            2700 => 10001.5,
                            3600 => 10001.5,
                            7200 => 10001.5,
                            10800 => 10001.5,
                            14400 => 10001.5,
                            86400 => 10001.5,
                        ],
                ],
                STR_EVENTS => [
                    STR_TOTAL => [
                        P_01MIN => 4,
                        P_03MIN => 12,
                        P_05MIN => 20,
                        P_15MIN => 60,
                        P_30MIN => 120,
                        P_45MIN => 180,
                        P_01HOUR => 240,
                        P_02HOUR => 480,
                        P_03HOUR => 720,
                        P_04HOUR => 960,
                        P_01DAY => 5760,
                    ],
                    STR_SELL => [
                        P_01MIN => 2,
                        P_03MIN => 6,
                        P_05MIN => 10,
                        P_15MIN => 30,
                        P_30MIN => 60,
                        P_45MIN => 90,
                        P_01HOUR => 120,
                        P_02HOUR => 240,
                        P_03HOUR => 360,
                        P_04HOUR => 480,
                        P_01DAY => 2880,
                    ],
                    STR_BUY => [
                        P_01MIN => 2,
                        P_03MIN => 6,
                        P_05MIN => 10,
                        P_15MIN => 30,
                        P_30MIN => 60,
                        P_45MIN => 90,
                        P_01HOUR => 120,
                        P_02HOUR => 240,
                        P_03HOUR => 360,
                        P_04HOUR => 480,
                        P_01DAY => 2880,
                    ],
                ],
            ];
        $this->assertEquals($expected, $this->counter->getVolumeArray(true));
        $expected = [
            STR_VOLUMES => [],
            STR_EVENTS => [],
        ];
        $this->assertEquals($expected, $this->counter->getRawData());
    }

    protected function tearDown()
    {
        unset($this->counter);
    }
}
